<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Form View -->
        <record id="view_l10n_cl_edi_certification_process_form" model="ir.ui.view">
            <field name="name">l10n_cl_edi.certification.process.form</field>
            <field name="model">l10n_cl_edi.certification.process</field>
            <field name="arch" type="xml">
                <form create="false" delete="false">
                    <!-- Agregar el campo computado que no será visible -->
                    <field name="active_company_id" invisible="1"/>
                    
                    <header>
                        <button name="action_prepare_certification" string="1. Preparar Certificación"
                                type="object" class="oe_highlight"
                                invisible="state != 'draft'"/>
                        <!-- Eliminamos el botón de CAFs Demo -->
                        <button name="action_process_set_prueba_xml" string="2. Cargar XML Set Pruebas"
                                type="object" class="oe_highlight"
                                invisible="state not in ('setup', 'data_loaded') or company_id == False"/>
                        <button name="action_generate_dte_documents" string="3. Generar Documentos DTE"
                                type="object" class="oe_highlight"
                                invisible="state != 'data_loaded' or dte_case_to_generate_count == 0"
                                help="Genera los documentos DTE definidos a partir del XML cargado."/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,setup,data_loaded,generation,finished"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_view_cafs" type="object" class="oe_stat_button" icon="fa-file-text-o">
                                <field name="caf_count" widget="statinfo" string="CAFs"/>
                            </button>
                            <button name="action_view_test_documents" type="object" class="oe_stat_button" icon="fa-file-o">
                                <field name="document_count" widget="statinfo" string="Documentos DTE Generados"/>
                            </button>
                            <button name="action_view_parsed_sets" type="object" class="oe_stat_button" icon="fa-files-o">
                                 <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_value"><field name="dte_case_to_generate_count" nolabel="1"/> Casos Pendientes</span>
                                    <span class="o_stat_text">Sets Definidos</span>
                                </div>
                            </button>
                        </div>
                        <div class="oe_title">
                            <h1>
                                <field name="company_id" options="{'no_create': True, 'no_open': True}" readonly="1"/>
                            </h1>
                        </div>
                        <notebook>
                            <page name="company_setup" string="Configuración Empresa">
                                <group>
                                    <group string="Configuración SII">
                                        <field name="dte_service_provider" required="1"/>
                                        <field name="dte_email" required="1"/>
                                        <field name="resolution_number" required="1"/>
                                        <field name="resolution_date" required="1"/>
                                        <field name="sii_regional_office" required="1"/>
                                    </group>
                                    <group string="Checklist Inicial">
                                        <field name="has_digital_signature" widget="boolean_toggle"/>
                                        <field name="has_company_activities" widget="boolean_toggle"/>
                                        <field name="has_required_cafs" widget="boolean_toggle"/>
                                    </group>
                                </group>
                                <group string="Actividades Económicas">
                                    <field name="company_activity_ids" widget="many2many_tags" options="{'no_create': True}" nolabel="1"/>
                                </group>
                            </page>
                            <page name="test_set_data" string="Datos Set de Pruebas (XML)">
                                <group>
                                    <field name="set_prueba_file" filename="set_prueba_filename"/>
                                    <field name="set_prueba_filename" invisible="1"/>
                                </group>
                                <group string="Sets de Pruebas Definidos" name="parsed_sets_group" invisible="not parsed_set_ids">
                                    <field name="parsed_set_ids" nolabel="1">
                                        <list editable="bottom" create="false" delete="false">
                                            <field name="sequence" widget="handle"/>
                                            <field name="name" readonly="1"/>
                                            <field name="set_type_normalized" readonly="1"/>
                                            <field name="attention_number" readonly="1"/>
                                        </list>
                                    </field>
                                </group>
                                <group string="Casos DTE a Generar" name="dte_cases_group" invisible="not parsed_set_ids">
                                     <field name="test_invoice_ids" nolabel="1" readonly="1"
                                           options="{'no_create': True, 'no_open': True}">
                                        <list>
                                            <field name="name"/>
                                            <field name="l10n_latam_document_type_id"/>
                                            <field name="partner_id"/>
                                            <field name="invoice_date"/>
                                            <field name="amount_total"/>
                                            <field name="l10n_cl_dte_status"/>
                                            <field name="l10n_cl_sii_send_ident"/>
                                        </list>
                                    </field>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- List View -->
        <record id="view_l10n_cl_edi_certification_process_list" model="ir.ui.view">
            <field name="name">l10n_cl_edi.certification.process.list</field>
            <field name="model">l10n_cl_edi.certification.process</field>
            <field name="arch" type="xml">
                <list>
                    <field name="company_id"/>
                    <field name="state"/>
                    <field name="dte_case_to_generate_count" string="Casos Pendientes"/>
                    <field name="document_count" string="DTEs Generados"/>
                    <field name="caf_count"/>
                </list>
            </field>
        </record>

        <!-- Acción para ver Parsed Sets -->
        <record id="action_l10n_cl_edi_certification_parsed_set" model="ir.actions.act_window">
            <field name="name">Sets de Pruebas</field>
            <field name="res_model">l10n_cl_edi.certification.parsed_set</field>
            <field name="view_mode">list,form</field>
            <field name="domain">[('certification_process_id', '=', active_id)]</field>
            <field name="context">{'default_certification_process_id': active_id}</field>
        </record>

        <!-- Minimal List view for Parsed Sets -->
        <record id="view_l10n_cl_edi_certification_parsed_set_list" model="ir.ui.view">
            <field name="name">l10n_cl_edi.certification.parsed_set.list</field>
            <field name="model">l10n_cl_edi.certification.parsed_set</field>
            <field name="arch" type="xml">
                <list>
                    <field name="sequence" widget="handle"/>
                    <field name="name"/>
                    <field name="set_type_normalized"/>
                    <field name="attention_number"/>
                    <field name="certification_process_id" invisible="1"/>
                </list>
            </field>
        </record>

        <!-- Form view for Parsed Sets -->
        <record id="view_l10n_cl_edi_certification_parsed_set_form" model="ir.ui.view">
            <field name="name">l10n_cl_edi.certification.parsed_set.form</field>
            <field name="model">l10n_cl_edi.certification.parsed_set</field>
            <field name="arch" type="xml">
                <form>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="name"/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="set_type_normalized"/>
                                <field name="attention_number"/>
                            </group>
                            <group>
                                <field name="certification_process_id" readonly="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Casos DTE" name="dte_cases" invisible="not dte_case_ids">
                                <field name="dte_case_ids">
                                    <list>
                                        <field name="case_number_raw"/>
                                        <field name="document_type_raw"/>
                                        <field name="document_type_code"/>
                                        <field name="generation_status"/>
                                        <field name="generated_account_move_id"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Entradas Libro de Compras" name="purchase_book" invisible="not purchase_book_entry_ids">
                                <field name="purchase_book_entry_ids">
                                    <list>
                                        <field name="sequence" widget="handle"/>
                                        <field name="document_type_raw"/>
                                        <field name="folio"/>
                                        <field name="amount_net_affected" sum="Total Afecto"/>
                                        <field name="amount_exempt" sum="Total Exento"/>
                                        <field name="processing_status"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Contenido Instruccional" name="instructional" invisible="not instructional_content_ids">
                                <field name="instructional_content_ids">
                                    <form>
                                        <group>
                                            <field name="instructions_text" widget="html"/>
                                            <field name="general_observations" widget="html"/>
                                        </group>
                                    </form>
                                </field>
                            </page>
                            <page string="Texto Original" name="raw_text">
                                <field name="raw_header_text" widget="text"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Acción para ver casos DTE -->
        <record id="action_l10n_cl_edi_certification_case_dte" model="ir.actions.act_window">
            <field name="name">Casos DTE</field>
            <field name="res_model">l10n_cl_edi.certification.case.dte</field>
            <field name="view_mode">list,form</field>
        </record>

        <!-- Form view for DTE Cases - corregido -->
        <record id="view_l10n_cl_edi_certification_case_dte_form" model="ir.ui.view">
            <field name="name">l10n_cl_edi.certification.case.dte.form</field>
            <field name="model">l10n_cl_edi.certification.case.dte</field>
            <field name="arch" type="xml">
                <form>
                    <header>
                        <field name="generation_status" widget="statusbar" statusbar_visible="pending,generated,error"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="case_number_raw"/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="document_type_raw"/>
                                <field name="document_type_code"/>
                                <field name="global_discount_percent" widget="percentage"/>
                                <field name="parsed_set_id"/>
                            </group>
                            <group>
                                <field name="generated_account_move_id" readonly="1"/>
                                <!-- Cambiar attrs por expresión directa -->
                                <field name="error_message" invisible="generation_status != 'error'"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Ítems" name="items">
                                <field name="item_ids">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="name"/>
                                        <field name="quantity"/>
                                        <field name="uom_raw"/>
                                        <field name="price_unit"/>
                                        <field name="discount_percent" widget="percentage"/>
                                        <field name="is_exempt"/>
                                    </list>
                                </field>
                            </page>
                            <page string="Referencias" name="references" invisible="not reference_ids">
                                <field name="reference_ids">
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="reference_document_text_raw"/>
                                        <field name="referenced_sii_case_number"/>
                                        <field name="reason_raw"/>
                                    </list>
                                </field>
                            </page>
                            <!-- Cambiar attrs por expresión directa -->
                            <page string="Datos de Guía" name="dispatch_data" invisible="document_type_code != '52'">
                                <group>
                                    <field name="dispatch_motive_raw"/>
                                    <field name="dispatch_transport_type_raw"/>
                                </group>
                            </page>
                            <!-- Cambiar attrs por expresión directa -->
                            <page string="Datos de Exportación" name="export_data" invisible="document_type_code not in ['110', '111', '112']">
                                <group>
                                    <group>
                                        <field name="export_reference_text"/>
                                        <field name="export_currency_raw"/>
                                        <field name="export_payment_terms_raw"/>
                                        <field name="export_sale_modality_raw"/>
                                    </group>
                                    <group>
                                        <field name="export_sale_clause_raw"/>
                                        <field name="export_total_sale_clause_amount"/>
                                        <field name="export_transport_way_raw"/>
                                        <field name="export_loading_port_raw"/>
                                        <field name="export_unloading_port_raw"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Texto Original" name="raw_text">
                                <field name="raw_text_block" widget="text"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- List view for DTE Cases -->
        <record id="view_l10n_cl_edi_certification_case_dte_list" model="ir.ui.view">
            <field name="name">l10n_cl_edi.certification.case.dte.list</field>
            <field name="model">l10n_cl_edi.certification.case.dte</field>
            <field name="arch" type="xml">
                <list>
                    <field name="case_number_raw"/>
                    <field name="document_type_raw"/>
                    <field name="document_type_code"/>
                    <field name="parsed_set_id"/>
                    <field name="generation_status"/>
                    <field name="generated_account_move_id"/>
                </list>
            </field>
        </record>

        <!-- Action: main entry point -->
        <record id="action_l10n_cl_edi_certification_process" model="ir.actions.act_window">
            <field name="name">Certificación SII</field>
            <field name="res_model">l10n_cl_edi.certification.process</field>
            <field name="view_mode">list,form</field>
            <field name="context">{'create_if_not_exist': True}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Inicie su proceso de certificación SII
                </p>
                <p>
                    Este asistente le guiará a través de todo el proceso de certificación
                    con el SII para la facturación electrónica.
                </p>
            </field>
        </record>

        <!-- Menu -->
        <menuitem id="menu_l10n_cl_edi_certification"
                  name="Certificación SII"
                  parent="l10n_cl_edi.menu_sii_chile"
                  sequence="25"
                  action="action_l10n_cl_edi_certification_process"/>
    </data>
</odoo>