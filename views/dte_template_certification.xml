<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- 
    Template inheritance para agregar referencias de certificación SII
    a las guías de despacho generadas durante el proceso de certificación.
    
    Este template extiende el template base de l10n_cl_edi_stock para:
    1. Agregar referencias SET obligatorias para certificación
    2. Corregir el motivo de traslado según tipo de movimiento
    3. Mantener compatibilidad con guías normales
    -->
    
    <template id="dte_certification_references" inherit_id="l10n_cl_edi_stock.dte_subtemplate">
        
        <!-- Agregar referencias de certificación ANTES de las referencias existentes -->
        <xpath expr="//t[@t-if='picking.sale_id.client_order_ref']" position="before">
            
            <!-- Referencias de certificación -->
            <t t-if="certification_references">
                <t t-foreach="certification_references" t-as="ref">
                    <Referencia>
                        <NroLinRef t-out="ref['sequence']"/>
                        <TpoDocRef t-out="ref['document_type']"/>
                        <FolioRef t-out="ref['folio']"/>
                        <FchRef t-out="ref['date']"/>
                        <RazonRef t-out="ref['reason']"/>
                    </Referencia>
                </t>
            </t>
            
        </xpath>
        
        <!-- También modificar la condición de la referencia original para que no aparezca si hay certificación -->
        <xpath expr="//t[@t-if='picking.sale_id.client_order_ref']" position="attributes">
            <attribute name="t-if">picking.sale_id.client_order_ref and not certification_references</attribute>
        </xpath>
        
        <!-- Corregir motivo de traslado para certificación -->
        <xpath expr="//IndTraslado" position="replace">
            <IndTraslado t-out="delivery_guide_reason or picking.l10n_cl_delivery_guide_reason or '1'"/>
        </xpath>
        
    </template>
    
    <!-- 
    Template adicional para campos específicos de certificación si es necesario
    Permite agregar otros campos que requieran lógica específica
    -->
    <template id="dte_certification_fields" inherit_id="l10n_cl_edi_stock.dte_subtemplate">
        
        <!-- Si necesitamos modificar otros campos específicos para certificación -->
        <!-- Por ejemplo, campos del emisor, receptor, etc. -->
        
        <!-- Por ahora solo comentarios para futuras extensiones -->
        
    </template>
    
</odoo>